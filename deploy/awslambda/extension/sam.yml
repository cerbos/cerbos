AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Cerbos server

Metadata:
  AWS::ServerlessRepo::Application:
    Name: "cerbos-lambda-extension"
    Description: "Cerbos is an authorization layer that evolves with your product. This Lambda function has a layer (extension) containing Cerbos Policy Decision Point (PDP). The layer can be attached to your Lambda function and serve its authorization needs. This is similar to a sidecar deployment pattern."
    Author: "Cerbos"
    SpdxLicenseId: Apache-2.0
    LicenseUrl: ../../../LICENSE
    ReadmeUrl: ../../../README.md
    Labels: 
      - authorization
      - access-control
      - RBAC
      - ABAC
      - PBAC
      - policy
      - security
      - sidecar
    HomePageUrl: https://cerbos.dev
    SourceCodeUrl: https://github.com/cerbos/cerbos

# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Timeout: 5

Resources:
  CerbosExtensionLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: cerbos-lambda-extension-layer
      Description: Cerbos extension layer
      ContentUri: ./layer
      CompatibleRuntimes:
        - provided.al2
      CompatibleArchitectures:
        - arm64

  CerbosServerFunctionZip:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: provided.al2
      CodeUri: dist/
      Handler: bootstrap
      Architectures:
        - arm64
      Layers:
        - CerbosExtensionLayer
      MemorySize: 1024
      Events:
        CatchAll:
          Type: HttpApi # More info about API Event Source: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#api
          Properties:
            Path: /{proxy+}
            Method: ANY
      Environment: # More info about Env Vars: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#environment-object
        Variables:
          BUCKET_URL: s3://test-dev.cerbos.dev
          BUCKET_PREFIX: policies
          CERBOS_LOG_LEVEL: debug
          XDG_CACHE_HOME: /tmp
          CERBOS_CONFIG: /var/task/.cerbos.yaml

Outputs:
  # ServerlessRestApi is an implicit API created out of Events key under Serverless::Function
  # Find out more about other implicit resources you can reference within SAM
  # https://github.com/awslabs/serverless-application-model/blob/master/docs/internals/generated_resources.rst#api
  CerbosServerFunctionAPI:
    Description: "API Gateway endpoint URL"
    Value: !Sub "https://${ServerlessHttpApi}.execute-api.${AWS::Region}.amazonaws.com"
  CerbosServerFunctionZip:
    Description: "Cerbos Server Function ARN"
    Value: !GetAtt CerbosServerFunctionZip.Arn
  CerbosFunctionIamRole:
    Description: "IAM Role created for the Cerbos Server function"
    Value: !GetAtt CerbosServerFunctionZipRole.Arn
  CerbosExtensionLayerX86Arn:
    Description: "Cerbos Extension Layer ARN for x86_64"
    Value: !Ref CerbosExtensionLayerX86
  CerbosExtensionLayerArm64Arn:
    Description: "Cerbos Extension Layer ARN for ARM64"
    Value: !Ref CerbosExtensionLayerArm64
