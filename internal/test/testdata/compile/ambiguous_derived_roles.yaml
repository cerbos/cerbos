---
wantErrors:
  - "resource_policies/leave_request_20210210.yaml: [ambiguous derived role] Derived role 'any_employee' is defined in more than one import: [beta,gamma]"
mainDef: "resource_policies/leave_request_20210210.yaml"
inputDefs:
  "resource_policies/leave_request_20210210.yaml":
    apiVersion: api.cerbos.dev/v1
    resourcePolicy:
      resource: leave_request
      version: "20210210"
      importDerivedRoles:
        - alpha
        - beta
        - gamma
      rules:
        - actions: ['*']
          effect: EFFECT_ALLOW
          roles:
            - admin
        - actions: ["create"]
          derivedRoles:
            - employee_that_owns_the_record
          effect: EFFECT_ALLOW
        - actions: ["view:*"]
          derivedRoles:
            - employee_that_owns_the_record
            - direct_manager
          effect: EFFECT_ALLOW
        - actions: ["view:public"]
          derivedRoles:
            - any_employee
          effect: EFFECT_ALLOW
        - actions: ["approve"]
          condition:
            match:
              expr: request.resource.attr.status == "PENDING_APPROVAL"
          derivedRoles:
            - direct_manager
          effect: EFFECT_ALLOW

  "derived_roles/alpha.yaml":
    apiVersion: "api.cerbos.dev/v1"
    derived_roles:
      name: alpha
      definitions:
        - name: tester
          parentRoles: ["dev", "qa"]

        - name: employee_that_owns_the_record
          parentRoles: ["employee"]
          computation:
            script: |-
              input.resource.attr.owner == input.principal.id

  "derived_roles/beta.yaml":
    apiVersion: "api.cerbos.dev/v1"
    derived_roles:
      name: beta
      definitions:
        - name: tester
          parentRoles: ["dev", "qa"]

        - name: any_employee
          parentRoles: ["employee"]

  "derived_roles/gamma.yaml":
    apiVersion: "api.cerbos.dev/v1"
    derived_roles:
      name: gamma
      definitions:
        - name: any_employee
          parentRoles: ["employee"]

        - name: direct_manager
          parentRoles: ["manager"]
          computation:
            match:
              all:
                of:
                  - expr: "request.resource.attr.geography == request.principal.attr.geography"
                  - expr: "request.resource.attr.geography == request.principal.attr.managed_geographies"
