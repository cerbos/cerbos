---
apiVersion: api.cerbos.dev/v1
variables:
  is_owner: R.attr.owner == request.principal.id
resourcePolicy:
  version: "default"
  resource: "list-resources:leave_request"
  importDerivedRoles:
    - apatr_common_roles
  rules:
    - actions: ["view2"]
      derivedRoles:
        - owner
      effect: EFFECT_ALLOW
    - actions: ["create", "view", "submit"]
      roles: ["employee"]
      effect: EFFECT_ALLOW
      condition:
        match:
          expr: V.is_owner
    - actions: ["approve"]
      roles: ["manager"]
      effect: EFFECT_ALLOW
      condition:
        match:
          all:
            of:
              - expr: 1 == 1
              - expr: R.attr.status == "PENDING_APPROVAL"
              - expr: R.attr.owner != request.principal.id
              - any:
                  of:
                    - expr: 1 != 1
                    - expr: R.attr.geography == request.principal.attr.geography
                    - expr: R.attr.geography in request.principal.attr.managed_geographies
    - actions: ["approve2"]
      roles: ["manager"]
      effect: EFFECT_ALLOW
      condition:
        match:
          all:
            of:
              - expr: 1 == 1
              - expr: R.attr.status == "PENDING_APPROVAL"
              - expr: R.attr.owner != request.principal.id
              - any:
                  of:
                    - expr: 1 == 1
                    - expr: R.attr.geography == request.principal.attr.geography
                    - expr: R.attr.geography in request.principal.attr.managed_geographies
    - actions: ["approve3"]
      roles: ["manager"]
      effect: EFFECT_ALLOW
      condition:
        match:
          all:
            of:
              - expr: 1 != 1
              - expr: R.attr.status == "PENDING_APPROVAL"
              - expr: R.attr.owner != request.principal.id
              - any:
                  of:
                    - expr: 1 == 1
                    - expr: R.attr.geography == request.principal.attr.geography
                    - expr: R.attr.geography in request.principal.attr.managed_geographies