# yaml-language-server: $schema=../.jsonschema/EngineTestCase.schema.json
---
description: Test output.when.ruleActivated, output.when.ruleNotActivated and deprecated output.expr doesn't interfere

inputs:
  - requestId: test
    actions:
      - approve
    principal:
      id: abc
      roles:
        - manager
      attr:
        geography: GB
        managed_geographies: GB
    resource:
      kind: equipment_request
      id: test
      attr:
        geography: GB
        status: PENDING_APPROVAL

  - requestId: test
    actions:
      - approve
    principal:
      id: abc
      roles:
        - manager
      attr:
        geography: GB
        managed_geographies: GB
    resource:
      kind: equipment_request
      id: test
      attr:
        geography: GB
        status: DRAFT

wantOutputs:
  - requestId: test
    resourceId: test
    effectiveDerivedRoles:
      - direct_manager
    actions:
      approve:
        effect: EFFECT_ALLOW
        policy: resource.equipment_request.vdefault
    outputs:
      - src: resource.equipment_request.vdefault#rule-002
        val: approval_status:abc:PENDING_APPROVAL

  - requestId: test
    resourceId: test
    effectiveDerivedRoles:
      - direct_manager
    actions:
      approve:
        effect: EFFECT_DENY
        policy: resource.equipment_request.vdefault
    outputs:
      - src: resource.equipment_request.vdefault#rule-002
        val: rule_not_activated

wantDecisionLogs:
  - callId: 01HKA8W61K5D3SHQSKC4ANEMSZ
    timestamp: "2023-12-01T14:57:59.181380904Z"
    auditTrail:
      effectivePolicies:
        resource.equipment_request.vdefault:
          attributes:
            driver: disk
            source: resource_policies/policy_07.yaml
    checkResources:
      inputs:
        - requestId: test
          actions:
            - approve
          principal:
            id: abc
            roles:
              - manager
            attr:
              geography: GB
              managed_geographies: GB
          resource:
            kind: equipment_request
            id: test
            attr:
              geography: GB
              status: PENDING_APPROVAL

        - requestId: test
          actions:
            - approve
          principal:
            id: abc
            roles:
              - manager
            attr:
              geography: GB
              managed_geographies: GB
          resource:
            kind: equipment_request
            id: test
            attr:
              geography: GB
              status: DRAFT
      outputs:
        - requestId: test
          resourceId: test
          actions:
            approve:
              effect: EFFECT_ALLOW
              policy: resource.equipment_request.vdefault
          effectiveDerivedRoles:
            - direct_manager
          outputs:
            - src: resource.equipment_request.vdefault#rule-002
              val: approval_status:abc:PENDING_APPROVAL

        - requestId: test
          resourceId: test
          actions:
            approve:
              effect: EFFECT_DENY
              policy: resource.equipment_request.vdefault
          effectiveDerivedRoles:
            - direct_manager
          outputs:
            - src: resource.equipment_request.vdefault#rule-002
              val: rule_not_activated
