---
apiVersion: api.cerbos.dev/v1
variables:
  is_owner: R.attr.owner == request.principal.id
resourcePolicy:
  version: "default"
  resource: "leave_request"
  importDerivedRoles:
    - beta
  rules:
    - actions: ["view:refer-derived-role"]
      derivedRoles:
        - owner
      effect: EFFECT_ALLOW
    - actions: ["create", "view", "submit"]
      roles: ["employee"]
      effect: EFFECT_ALLOW
      condition:
        match:
          expr: V.is_owner
    - actions: ["approve"]
      roles: ["manager"]
      effect: EFFECT_ALLOW
      condition:
        match:
          all:
            of:
              - expr: 1 == 1
              - expr: R.attr.status == "PENDING_APPROVAL"
              - expr: R.attr.owner != request.principal.id
              - any:
                  of:
                    - expr: 1 != 1
                    - expr: R.attr.geography == request.principal.attr.geography
                    - expr: R.attr.geography in request.principal.attr.managed_geographies
    - actions: ["approve:refer-derived-role"]
      effect: EFFECT_ALLOW
      derivedRoles:
        - direct_manager
      condition:
        match:
          all:
            of:
              - expr: R.attr.status == "PENDING_APPROVAL"
              - expr: R.attr.owner != request.principal.id
    - actions: ["report"]
      roles: ["manager"]
      effect: EFFECT_DENY
      condition:
        match:
          expr: R.attr.deleted
    - actions: ["approve:true-in-both-or-and-conditions"]
      roles: ["manager"]
      effect: EFFECT_ALLOW
      condition:
        match:
          all:
            of:
              - expr: 1 == 1
              - expr: R.attr.status == "PENDING_APPROVAL"
              - expr: R.attr.owner != request.principal.id
              - any:
                  of:
                    - expr: 1 == 1
                    - expr: R.attr.geography == request.principal.attr.geography
                    - expr: R.attr.geography in request.principal.attr.managed_geographies
    - actions: ["approve:false-in-and-condition"]
      roles: ["manager"]
      effect: EFFECT_ALLOW
      condition:
        match:
          all:
            of:
              - expr: 1 != 1
              - expr: R.attr.status == "PENDING_APPROVAL"
              - expr: R.attr.owner != request.principal.id
              - any:
                  of:
                    - expr: 1 == 1
                    - expr: R.attr.geography == request.principal.attr.geography
                    - expr: R.attr.geography in request.principal.attr.managed_geographies