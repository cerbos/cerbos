include::ROOT:partial$attributes.adoc[]

[#v0.33.0]
= Cerbos v0.33.0


== Highlights

Producing user-defined output from policy evaluation is now more expressive and includes the option `when.conditionNotMet` to produce output when the condition of a rule is not satisfied as well. This simplifies crafting policies for certain scenarios where it's useful to know that some criteria was not met. As a part of this update, the structure of the `output` block has changed to make it clearer and easier to understand. Old policies will continue to work but we recommend updating your policies to use the new output syntax as follows.

[options="header",cols="a,a"]
|===
| Old syntax
| New syntax
|
[source,yaml]
----
- actions: ['view']
  effect: EFFECT_ALLOW
  roles: ["user"]
  condition:
  match:
    expr: request.resource.attr.public == true
  output:
    expr: >
      "%s allowed to view".format([request.principal.id])
----
|
[source,yaml]
----
- actions: ['view']
  effect: EFFECT_ALLOW
  roles: ["user"]
  condition:
    match:
      expr: request.resource.attr.public == true
  output:
    when:
      ruleActivated: >
        "%s allowed to view".format([request.principal.id])
----
|===

This release contains audit log improvements to provide more comprehensive visibility over policy revisions used for access decisions and ways to easily join application logs to Cerbos audit logs.

Audit log entries now contain store-specific metadata about the policies used to make the decision. For example, if the git store is used, the git commit hash of the policy used by the Cerbos engine is recorded in the audit log. This information can then be used to match access control decisions to the revision history of the policy repository during a security investigation.

The API response now include the unique call ID generated by Cerbos to create the audit log entry for that request. Applications can record this ID in their own logs to enable cross-referencing Cerbos audit logs with application logs.

As announced earlier, this release removes the deprecated `client` package and drops support for configuring distributed traces using the `tracing` configuration block. The official Go SDK is available at https://github.com/cerbos/cerbos-sdk-go and is largely a drop-in replacement with a few package renames. For the new way of configuring traces, refer to the xref:configuration:tracing.adoc#migration[migration instructions].


== Changelog

=== Bug Fixes

* Don't forward connection-specific headers via gRPC-Gateway (link:https://github.com/cerbos/cerbos/pull/1938[#1938])
* Query planner doesn't use stable time (link:https://github.com/cerbos/cerbos/pull/1949[#1949])
* Query planner must (pre)evaluate expressions with resource kind (link:https://github.com/cerbos/cerbos/pull/1921[#1921])
* Restore `User-Agent` header aliasing (link:https://github.com/cerbos/cerbos/pull/1941[#1941])

=== Features

* Add audit call ID to API responses (link:https://github.com/cerbos/cerbos/pull/1911[#1911])
* Produce output if condition fails (link:https://github.com/cerbos/cerbos/pull/1932[#1932])
* Record policy source attributes in audit log  (link:https://github.com/cerbos/cerbos/pull/1889[#1889])

=== Enhancements

* Add Admin API update timestamp to policy (link:https://github.com/cerbos/cerbos/pull/1903[#1903])
* Add podLabels to the chart (link:https://github.com/cerbos/cerbos/pull/1912[#1912])
* Configurable database connection retries (link:https://github.com/cerbos/cerbos/pull/1926[#1926])
* #**BREAKING**# Drop support for tracing configuration block (link:https://github.com/cerbos/cerbos/pull/1898[#1898])
* Pass all HTTP headers through unmodified from gRPC-Gateway (link:https://github.com/cerbos/cerbos/pull/1934[#1934])
* #**BREAKING**# Remove deprecated client package (link:https://github.com/cerbos/cerbos/pull/1904[#1904])

=== Documentation

* Add policy variable examples (link:https://github.com/cerbos/cerbos/pull/1940[#1940])
* Fix image URLs (link:https://github.com/cerbos/cerbos/pull/1943[#1943])
* Fix incorrect policy rule in tutorial (link:https://github.com/cerbos/cerbos/pull/1930[#1930])
* Remove older versions (link:https://github.com/cerbos/cerbos/pull/1942[#1942])

=== Chores

* Add 0.32.0 release notes (link:https://github.com/cerbos/cerbos/pull/1894[#1894])
* Bump github.com/cloudflare/circl from 1.3.3 to 1.3.7 (link:https://github.com/cerbos/cerbos/pull/1935[#1935])
* Bump github.com/cloudflare/circl from 1.3.5 to 1.3.7 in /tools (link:https://github.com/cerbos/cerbos/pull/1936[#1936])
* Bump github.com/go-git/go-git/v5 from 5.7.0 to 5.11.0 in /tools (link:https://github.com/cerbos/cerbos/pull/1925[#1925])
* Bump golang.org/x/crypto from 0.15.0 to 0.17.0 in /tools (link:https://github.com/cerbos/cerbos/pull/1916[#1916])
* Bump version to 0.33.0
* Downgrade github.com/chigopher/pathlib (link:https://github.com/cerbos/cerbos/pull/1924[#1924])
* Ignore source attributes in cerbosctl tests (link:https://github.com/cerbos/cerbos/pull/1908[#1908])
* Readme update (link:https://github.com/cerbos/cerbos/pull/1937[#1937])
* Revert "docs: Fix image URLs (link:https://github.com/cerbos/cerbos/pull/1943[#1943])
* Tag API module during release (link:https://github.com/cerbos/cerbos/pull/1909[#1909])
* Tidy dependencies (link:https://github.com/cerbos/cerbos/pull/1899[#1899])
* Tidy dependencies (link:https://github.com/cerbos/cerbos/pull/1907[#1907])
* Update actions/setup-go action to v5 (link:https://github.com/cerbos/cerbos/pull/1906[#1906])
* Update buf modules (link:https://github.com/cerbos/cerbos/pull/1902[#1902])
* Update copyright header (link:https://github.com/cerbos/cerbos/pull/1931[#1931])
* Update github actions deps to v3 (major) (link:https://github.com/cerbos/cerbos/pull/1915[#1915])
* Update github actions deps to v4 (major) (link:https://github.com/cerbos/cerbos/pull/1923[#1923])
* Update go deps (link:https://github.com/cerbos/cerbos/pull/1896[#1896])
* Update go deps (link:https://github.com/cerbos/cerbos/pull/1905[#1905])
* Update go deps (link:https://github.com/cerbos/cerbos/pull/1914[#1914])
* Update go deps (link:https://github.com/cerbos/cerbos/pull/1922[#1922])
* Update go deps (link:https://github.com/cerbos/cerbos/pull/1928[#1928])
* Update go deps (link:https://github.com/cerbos/cerbos/pull/1933[#1933])
* Update go deps (link:https://github.com/cerbos/cerbos/pull/1950[#1950])
* Update google-github-actions/auth action to v2 (link:https://github.com/cerbos/cerbos/pull/1897[#1897])
* Update google-github-actions/setup-gcloud action to v2 (link:https://github.com/cerbos/cerbos/pull/1929[#1929])
* Update module golang.org/x/crypto to v0.17.0 [security] (link:https://github.com/cerbos/cerbos/pull/1917[#1917])
* YAML to Protobuf parser  (link:https://github.com/cerbos/cerbos/pull/1939[#1939])
